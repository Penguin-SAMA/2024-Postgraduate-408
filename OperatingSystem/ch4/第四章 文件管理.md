# 4.1 文件系统基础

## 4.1.1 文件的基本概念

**文件**是以硬盘为载体的存储在计算机上的信息集合，文件可以是文本文档、图片、程序等。

在系统运行时，计算机以进程为基本单位进行资源的调度和分配；

而在用户进行的输入、输出中，则以文件为基本单位。

从用户角度看，文件是输入输出的基本单位。文件是逻辑外存的最小分配单元，数据只有通过文件才能写到外存。

**文件系统**是操作系统中负责存取和管理信息的模块，它采用统一方法对系统和用户的信息进行存储、检索、更新、共享和保护，并为用户提供一整套行之有效的文件使用及操作方法。

文件系统使用**文件**和**树形目录**的抽象逻辑概念代替了硬盘和光盘等物理设备使用的数据块的概念，用户不必关心数据实际保存在哪个存储介质的什么位置上，只需记住该文件的所属目录和文件名就能操作文件。

通常把数据组成分为数据项、记录和文件三级。

![image-20230621124423515](./assets/image-20230621124423515.png)

-   数据项：数据项是基本的数据单元，是文件系统中最低级的数据组织形式，分为以下两种类型：
    -   基本数据项：用于描述一个对象的某种属性的字符集，是数据中可命名的最小逻辑数据单位，又称为字段。
    -   组合数据项：由多个基本数据项组成，简称组项。
-   记录：记录是一组相关的数据项的集合，用于描述一个对象在某方面的属性。
-   文件：文件是由创作者所定义的、具有文件名的一组相关元素的集合，可分为以下两种：
    -   有结构文件：文件由若干个相关记录组成
    -   无结构文件：长度以字节为单位的字符流

## 4.1.2 文件元数据和索引节点

### 1. 文件元数据

-   **文件元数据**又称**文件属性**。
-   文件属性在不同系统中差别很大，但通常都包括如下属性：
    -   **名称：**文件名称唯一，以容易读取的形式保存。
    -   **类型：**被支持不同类型的文件系统所使用。
    -   **创建者：**文件创建者的ID。
    -   **所有者：**文件当前所有者的ID。
    -   **位置：**指向设备和设备上文件的指针。
    -   **大小：**文件当前大小，也可包含文件允许的最大值。
    -   **保护：**对文件进行保护的访问控制信息。
    -   **创建时间、最后一次修改时间和最后一次存取时间：**文件创建、上次修改和上次访问的相关信息，用于保护和跟踪文件的使用。
-   操作系统通过**文件控制块**(FCB)来维护文件元数据。

### 2. 文件控制块

文件控制块是操作系统为每个文件建立的唯一数据结构，用于管理、控制和按名存储文件，其中包含了全部文件属性。一个文件由两部分组成：**FCB**和**文件数据**。文件和FCB一一对应。

-   每当创建一个文件时，系统就要为其建立一个FCB，用来记录文件的属性信息；
-   每当存取文件时，先找到其FCB，再通过FCB内的属性找到文件的物理位置就能存取。

### 3. 索引结点

>    操作系统再查找文件时只是用文件名进行查找，仅当文件名匹配时才会读取文件的其他信息。因此在有的系统中采用了文件名和文件描述信息分开存放的办法，即将文件描述信息放到一个单独的数据结构中，这个数据结构称为**索引结点**。

-   索引结点(简称i结点)，是一种记录了文件描述信息的数据结构，是文件的唯一标识，和文件一一对应。除了文件名以外的所有文件信息，都存在索引结点中。

#### 磁盘索引结点包含的信息

-   文件主标识符：拥有该文件的个人或小组的标识符。
-   文件类型：包括普通文件、目录文件或特别文件。
-   文件存取权限：各类用户对该文件的存取权限。
-   文件物理地址：每个索引结点中含有13个地址项，它们以直接或间接方式给出数据文件所在盘块的编号。
-   文件长度：以字节为单位的文件长度。
-   文件链接计数：在本文件系统中所有指向该文件的文件名的指针计数。
-   文件存取时间：本文最近被进程存取的时间、最近被修改的时间及索引结点最近被修改的时间。

#### 内存索引结点的信号

-   索引节点编号：用于标识内存索引结点。
-   状态：指示i结点是否上锁或被修改。
-   访问计数：每当有一进程要访问此i结点时，将访问计数加1，访问结束减1
-   逻辑设备号：文件所属文件系统的逻辑设备号。
-   链接指针：设置分别指向空闲链表和散列队列的指针。

## 4.1.3 文件的操作

>   介绍文件操作前，首先介绍两个重要的数据结构。

#### 系统打开文件表

系统打开文件表是一个维护所有进程打开文件的系统级描述符表，表项中描述了一个打开文件的所有信息。

系统打开文件表中内容如下：

-   索引节点指针，指向文件的索引节点的指针。
-   文件偏移量，表示文件上次读写位置，又称读写指针。
-   文件访问模式，如只读模式、只写模式或读写模式。
-   文件打开计数，表示当前有多少个进程打开了这个文件。

#### 文件描述符表(用户打开文件表)

文件描述符表是一个用来记录用户进程当前打开的所有文件的进程级描述符表，存储在PCB中。

表项索引值为**文件描述符**，是一个非负整数，每个文件描述符对应一个指针，指针指向系统打开文件表的一个表项。

![彻底搞懂文件描述符/文件句柄/文件指针的区别与联系 - 简书](https://th.bing.com/th/id/OIP.cTqmB16GEe75sTo20VhmZwHaFL?pid=ImgDet&rs=1)

### 1. 建立文件

建立文件的系统调用格式为：`fd = create(filename, mode)`，其中`filename`是指向所要创建的文件路径名的字符串指针，`mode`是文件存取权限，如可读、可写、可执行等，创建成功后返回文件描述符`fd`。

建立文件的操作如下：

1.   先在文件系统中为文件找到空间，然后为新文件分配磁盘索引节点、内存索引节点和FCB，并把文件名和磁盘索引节点指针组成新的目录项，记录到当前目录的目录文件中；
2.   设置文件内存索引结点的信息；
3.   为新文件分配用户打开文件表项和系统打开文件表项，为后者设置初值，最后返回文件描述符`fd`。

>   💡上述步骤中都有打开文件的功能，因此，创建文件后无需再次打开文件。

### 2. 删除文件

删除文件的系统调用格式为：`unlink(filename)`，调用成功返回0，失败返回-1。

删除文件时，应删除文件目录中相应的目录项，然后把该文件占用的存储空间释放。

删除文件要求用户对文件具有“写”操作权。

### 3. 打开文件

打开文件系统调用的格式为：`fd = open(filename, mode)`，其中`mode`表示文件打开方式。

打开文件后，文件的读写和关闭都不再以文件路径为参数，而是以打开文件返回的**文件标识符**`fd`为参数，即必须打开文件后，才可以进行文件读写和关闭操作。

打开文件的操作如下：

1.   检索目录，要求打开的文件必须已经被创建，因此应在文件目录中存在对应的表项，否则会出错。
2.   比较参数`mode`和内存索引节点中在建立文件时所记录的访问权限，如果非法，则此次打开操作失败。
3.   打开合法时，为文件分配用户打开文件表项，并为后者设置初值，通过指针建立表项与内存索引节点之间的联系，再把文件描述符`fd`返回给调用者。

>   💡打开文件不会将文件内容调入内存，只会将FCB写入内存，只有进程希望获取文件内容时才会从磁盘读取文件内容。

>   💡多个进程同时打开同一个文件时，可以任意对文件进行读写操作，操作系统并不保证写的互斥性，进程可以通过系统调用对文件加锁，从而实现对文件内容的保护。

### 4. 关闭文件

关闭文件的系统调用格式为`close(fd)`，`fd`表示文件描述符，调用成功返回0，失败返回-1。

关闭文件操作如下：

1.   根据`fd`找到用户打开文件表项，再找到系统打开文件表项，将该文件从用户打开文件表目上删除；
2.   把对应系统打开文件表项中的文件打开计数减1，如果其值不为0，说明还有其他进程正在共享它，不用释放此表项直接返回，否则释放此表项并找到相应的内存索引结点。
3.   把内存索引结点中引用计数减1，如果其值不为0，说明还有其他进程正在使用此文件，直接返回，否则将内存索引节点复制到相应的磁盘索引节点中，释放此内存索引节点。

>   💡关闭文件以及读、写文件之前需要先打开文件，获取文件描述符，关闭和读、写文件使用文件描述符而不是文件路径名作为参数。

>   💡系统打开文件表中文件打开计数和索引结点中的引用计数不同，前者反映多少进程通过同一个读写指针共享文件，后者反映多少进程共享文件。

### 5. 读文件

读文件的系统调用格式为：`n = read(fd, buf, count)`，表示从文件描述符`fd`表示的文件中的当前文件偏移量开始，读取`count`个字节的数据，并把它们放到数据区`buf`中，返回实际读入的字节数，它可能会小于请求的字节数，因为一旦读到文件末尾系统调用就返回。

### 6. 写文件

写文件的系统调用格式为：`n = write(fd, buf, count)`，表示把缓冲区`buf`的前`count`个字节写入`fd`表示的文件中的当前文件偏移量开始的位置，成功时返回写入的字节数，错误时返回-1。

## 4.1.4 文件的保护

